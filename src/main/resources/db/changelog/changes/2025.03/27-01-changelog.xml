<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.15.xsd">

    <changeSet id="20230327-1-create-get-top-category-function" author="yourname">
        <preConditions onFail="HALT">
            <!-- Проверка существования таблицы categories -->
            <tableExists tableName="categories"/>
        </preConditions>
        <comment>Создание функции get_top_category для получения идентификатора верхней категории</comment>
        <sql splitStatements="false" endDelimiter=";">
            <![CDATA[
            CREATE OR REPLACE FUNCTION get_top_category(category_id BIGINT)
            RETURNS BIGINT AS $BODY$
            WITH RECURSIVE cat_parent AS (
            SELECT id, parent_category_id
            FROM categories
            WHERE id = category_id
            UNION ALL
            SELECT c.id, c.parent_category_id
            FROM categories c
            INNER JOIN cat_parent cp ON c.id = cp.parent_category_id
            )
            SELECT id FROM cat_parent WHERE parent_category_id IS NULL LIMIT 1;
            $BODY$ LANGUAGE sql IMMUTABLE;
            ]]>
        </sql>
    </changeSet>

</databaseChangeLog>
